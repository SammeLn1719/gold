{% extends 'base.html' %}
{% load static %}

{% block title %}–ö–æ—Ä–∑–∏–Ω–∞ –ø–æ–∫—É–ø–æ–∫{% endblock %}

{% block content %}
<div class="container">
    <h1 class="cart-title">üõí –ö–æ—Ä–∑–∏–Ω–∞ –ø–æ–∫—É–ø–æ–∫</h1>
    
    {% if cart %}
    
    
    {% if has_warnings %}
    <div class="cart-global-warning">
        ‚ö†Ô∏è –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–æ–≤–∞—Ä—ã —Ç—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–µ–¥ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º –∑–∞–∫–∞–∑–∞.
    </div>
    {% endif %}
    
    <div class="cart-container">
        <table class="cart-table">
            <thead>
                <tr>
                    <th>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</th>
                    <th>–¢–æ–≤–∞—Ä</th>
                    <th>–¶–µ–Ω–∞</th>
                    <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                    <th>–°—É–º–º–∞</th>
                    <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                </tr>
            </thead>
            <tbody>
                {% for item_data in cart_items_with_warnings %}
                {% with item=item_data.item %}
                <tr class="cart-item {% if item_data.has_warning %}cart-item-warning{% endif %}">
                    <td class="cart-item-image" data-label="">
                        <img src="{{ item.product.get_image_url }}" 
                             alt="{{ item.product.name }}">
                    </td>
                    <td class="cart-item-name" data-label="–¢–æ–≤–∞—Ä:">
                        <a href="{{ item.product.get_absolute_url }}">
                            {{ item.product.name }}
                        </a>
                        <span class="cart-item-category">{{ item.product.category.name }}</span>
                        
                        
                        {% if item_data.has_warning %}
                        <div class="item-warning">
                            <span class="warning-icon">‚ö†Ô∏è</span>
                            <span class="warning-text">{{ item_data.warning_message }}</span>
                        </div>
                        {% endif %}
                    </td>
                    <td class="cart-item-price" data-label="–¶–µ–Ω–∞:">{{ item.price|floatformat:2 }} ‚ÇΩ</td>
                    <td class="cart-item-quantity" data-label="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:">
                        <form action="{% url 'cart:cart_update' item.product.id %}" 
                              method="post" 
                              class="quantity-form">
                            {% csrf_token %}
                            <div class="quantity-controls-improved" data-max="{{ item.product.stock }}">
                                <button type="button" class="btn-qty btn-qty-dec" aria-label="–£–º–µ–Ω—å—à–∏—Ç—å">‚àí</button>
                                <input type="number" 
                                       name="quantity" 
                                       value="{{ item.quantity }}" 
                                       min="1"
                                       max="{{ item.product.stock }}"
                                       class="quantity-input-improved {% if item_data.has_warning %}input-warning{% endif %}">
                                <button type="button" class="btn-qty btn-qty-inc" aria-label="–£–≤–µ–ª–∏—á–∏—Ç—å">+</button>
                                <button type="submit" class="btn-update" title="–û–±–Ω–æ–≤–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ">‚úì</button>
                            </div>
                            <small class="stock-hint">
                                {% if item.product.stock > 0 %}
                                    –ù–∞ —Å–∫–ª–∞–¥–µ: {{ item.product.stock }} —à—Ç
                                {% else %}
                                    <span class="out-of-stock">–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</span>
                                {% endif %}
                            </small>
                        </form>
                    </td>
                    <td class="cart-item-total" data-label="–°—É–º–º–∞:">{{ item.total_price|floatformat:2 }} ‚ÇΩ</td>
                    <td class="cart-item-actions" data-label="">
                        <form action="{% url 'cart:cart_remove' item.product.id %}" 
                              method="post">
                            {% csrf_token %}
                            <button type="submit" class="btn-remove" title="–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä">
                                üóëÔ∏è
                            </button>
                        </form>
                    </td>
                </tr>
                {% endwith %}
                {% endfor %}
            </tbody>
        </table>
        
        <div class="cart-summary">
            <div class="cart-summary-content">
                <h2>–ò—Ç–æ–≥–æ</h2>
                <div class="cart-summary-row">
                    <span>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤:</span>
                    <strong>{{ cart|length }} —à—Ç.</strong>
                </div>
                <div class="cart-summary-row cart-total">
                    <span>–û–±—â–∞—è —Å—É–º–º–∞:</span>
                    <strong class="total-price">{{ cart.get_total_price|floatformat:2 }} ‚ÇΩ</strong>
                </div>
                
                {% if has_warnings %}
                <div class="checkout-warning">
                    ‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ –ø–µ—Ä–µ–¥ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º
                </div>
                {% endif %}
                
                <div class="cart-actions">
                    <a href="{% url 'category:product_list' %}" class="btn-continue">
                        ‚Üê –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∫—É–ø–∫–∏
                    </a>
                    <button class="btn-checkout" disabled title="–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ - –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ">
                        –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ ‚Üí
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    {% else %}
    <div class="cart-empty">
        <div class="cart-empty-icon">üõí</div>
        <h2>–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</h2>
        <p>–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –ø–æ–∫—É–ø–∫–∏</p>
        <a href="{% url 'category:product_list' %}" class="btn-to-catalog">
            –ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}
{% block extra_js %}
<script>
(function(){
  const containers = document.querySelectorAll('.quantity-controls-improved');
  containers.forEach(function(box){
    const input = box.querySelector('input[type="number"]');
    const dec = box.querySelector('.btn-qty-dec');
    const inc = box.querySelector('.btn-qty-inc');
    if(!input || !dec || !inc) return;
    const min = parseInt(input.getAttribute('min') || '1', 10);
    const maxAttr = input.getAttribute('max');
    const max = maxAttr ? parseInt(maxAttr, 10) : Number.POSITIVE_INFINITY;
    function clamp(val){
      if (isNaN(val)) return min;
      return Math.max(min, Math.min(max, val));
    }
    dec.addEventListener('click', function(){
      input.value = clamp(parseInt(input.value || '1', 10) - 1);
    });
    inc.addEventListener('click', function(){
      input.value = clamp(parseInt(input.value || '1', 10) + 1);
    });
  });
})();
</script>
{% endblock %}
